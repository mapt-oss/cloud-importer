apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cloud-importer-share-aws
  labels:
    app.kubernetes.io/version: "<VERSION>"
  annotations:
    tekton.dev/pipelines.minVersion: "0.44.x"
    tekton.dev/categories: infrastructure
    tekton.dev/tags: infrastructure, aws, share
    tekton.dev/displayName: "CloudImporter Share AWS"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This Task shares an AMI to another AWS account or organization using the cloud-importer tool.
  params:
    - name: image-id
      description: The ID of the AMI to be shared.
    - name: account-id
      description: Target account ID to share the AMI to.
      default: ""
    - name: organization-arn
      description: Organization to share the AMI to.
      default: ""
    - name: arch
      description: The architecture of the image (x86_64 or arm64).
      default: "x86_64"
    - name: id
      description: identifier for the taskrun
    - name: debug
      description: run with deug logs
  workspaces:
    - name: credentials
      description: A workspace containing the cloud provider credentials.
      mountPath: /opt/aws-credentials
  steps:
    - name: run-cloud-importer
      image: <IMAGE>
      script: |
        #!/bin/sh

        set -euo pipefail

        if [ ! -z "$(params.account-id)" ] && [ ! -z "$(params.organization-arn)" ]; then
          echo "ERROR: only one of 'account-id', 'organization-arn' should be used, provided both."
          exit 1
        fi

        # Function to mask credentials (show first and last char, hide middle)
        mask_credential() {
          local cred="$1"
          local len=${#cred}
          if [ $len -le 2 ]; then
            echo "***"
          else
            echo "${cred:0:1}***${cred: -1}"
          fi
        }

        # Credentials - set these BEFORE enabling debug mode
        export AWS_ACCESS_KEY_ID=$(cat /opt/aws-credentials/access-key)
        export AWS_SECRET_ACCESS_KEY=$(cat /opt/aws-credentials/secret-key)
        export AWS_DEFAULT_REGION=$(cat /opt/aws-credentials/region)
        BUCKET=$(cat /opt/aws-credentials/bucket)

        # If debug add verbosity and print masked credentials
        if [[ "$(params.debug)" == "true" ]]; then
          echo "AWS_ACCESS_KEY_ID=$(mask_credential "$AWS_ACCESS_KEY_ID")"
          echo "AWS_SECRET_ACCESS_KEY=$(mask_credential "$AWS_SECRET_ACCESS_KEY")"
          echo "AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION"
          echo "BUCKET"=$BUCKET
          set -xeuo pipefail
        fi

        cmd="cloud-importer share aws "
        cmd+="--image-id $(params.image-id) "
        cmd+="--region $(params.region) "
        if [ -n "$(params.account-id)" ]; then cmd+="--accout-id $(params.account-id) "; fi
        if [ -n "$(params.organization-arn)" ]; then cmd+="--organization-arn $(params.organization-arn) "; fi
        cmd+="--backed-url s3://${BUCKET}/cloud-importer/$(params.id) "

        if [[ "$(params.debug)" == "true" ]]; then
          cmd+="--debug"
        fi

        eval ${cmd}

